import {
    Controller,
    Get,
    Post,
    Body,
    Logger,
    ValidationPipe,
    HttpException,
    HttpStatus,
    Req,
    UseGuards
} from '@nestjs/common'
import { Channel } from '../entities/channel.entity'
import { MessageService } from '../services/message.service'
import { ChannelService } from '../services/channel.service'
import { UserService } from '../../user/services/user/user.service'
import { CreateDmChannelDto, CreateGroupChannelDto } from '../dtos/chat.dtos'
import { ChatGateway } from '../gateway/chat.gateway'
import { GroupProfileService } from '../services/groupProfile.service'
import { FortyTwoAuthGuard } from '../../auth/auth.guard'

@Controller('chat')
export class ChatController {
    constructor(
        private readonly channelService: ChannelService,
        private readonly messageService: MessageService,
        private readonly userService: UserService,
        private readonly chatGateway: ChatGateway,
        private readonly groupProfileService: GroupProfileService
    ) {}

    private logger = new Logger('ChatController')

    // Get /api/chat/
    @UseGuards(FortyTwoAuthGuard)
    @Get('/')
    async getUserChannels(@Req() req): Promise<Channel[]> {
        try {
            const id = req.session.user.id
            this.logger.log('getChannelMessages: messages found for user: ' + id)
            const channels = await this.channelService.getUserChannels(id)
            return channels
        } catch (err) {
            this.logger.error('getChannelMessages: ' + err)
        }
    }

    // Post /api/chat/dm
    @UseGuards(FortyTwoAuthGuard)
    @Post('dm')
    async postNewDMChannel(
        @Req() req,
        @Body(new ValidationPipe()) param: CreateDmChannelDto
    ): Promise<any> {
        try {
            const id = req.session.user.id
            const user1 = await this.userService.getUserById(id)
            if (!user1) {
                throw new HttpException(
                    'Could not find user1 by id to create new dm channel',
                    HttpStatus.FORBIDDEN
                )
            }
            const user2 = await this.userService.getUserByLogin(param.invitee)
            if (!user2) {
                throw new HttpException(
                    'Could not find user2 by invitee to create new dm channel',
                    HttpStatus.FORBIDDEN
                )
            }
            let channel = await this.channelService.newDmChannel(user1, user2)
            channel = await this.channelService.getChannelById(channel.id)
            await this.chatGateway.emitNewDmChannel(user1, user2, channel)
            return
        } catch (error) {
            this.logger.error('postNewDMChannel: ' + error)
            if (error instanceof HttpException) throw error
            throw error
        }
    }

    // Post /api/chat/group
    @UseGuards(FortyTwoAuthGuard)
    @Post('group')
    async postNewGroupChannel(
        @Req() req,
        @Body(new ValidationPipe()) param: CreateGroupChannelDto
    ): Promise<any> {
        try {
            const id = req.session.user.id
            await this.groupProfileService.checkValidGroupName(param.groupName)
            const owner = await this.userService.getUserById(id)
            if (!owner) {
                throw new HttpException(
                    'Could not find user to create new group channel',
                    HttpStatus.FORBIDDEN
                )
            }
            let channel = await this.channelService.newGroupChannel(
                owner,
                param.groupName,
                param.type,
                param.password
            )
            if (!channel) {
                throw new HttpException('Could not create new group channel', HttpStatus.FORBIDDEN)
            }
            channel = await this.channelService.getChannelById(channel.id)
            await this.chatGateway.emitGroupChannelToUser(channel, owner)
            return
        } catch (error) {
            this.logger.error('postNewGroupChannel: ' + error)
        }
    }
}
